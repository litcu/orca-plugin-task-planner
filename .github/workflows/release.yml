name: Release Plugin Package

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g. v1.2.3)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_TAG }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build plugin
        run: npm run build

      - name: Validate tag format
        run: |
          if [[ ! "${RELEASE_TAG}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+([.-].+)?$ ]]; then
            echo "Invalid tag format: ${RELEASE_TAG}. Expected v<semver>."
            exit 1
          fi

      - name: Validate tag version
        run: |
          TAG_VERSION="${RELEASE_TAG#v}"
          PACKAGE_VERSION="$(node -p "require('./package.json').version")"
          if [ "${TAG_VERSION}" != "${PACKAGE_VERSION}" ]; then
            echo "Tag version (${TAG_VERSION}) does not match package.json version (${PACKAGE_VERSION})."
            exit 1
          fi

      - name: Package release zip
        run: |
          PLUGIN_DIR="orca-task-planner"
          ARCHIVE_NAME="${PLUGIN_DIR}-${RELEASE_TAG}.zip"

          mkdir -p "release/${PLUGIN_DIR}/dist"
          cp "dist/index.js" "release/${PLUGIN_DIR}/dist/index.js"
          cp "package.json" "release/${PLUGIN_DIR}/package.json"
          cp "README.md" "release/${PLUGIN_DIR}/README.md"

          if [ -f "README_zh.md" ]; then
            cp "README_zh.md" "release/${PLUGIN_DIR}/README_zh.md"
          fi

          if [ -f "icon.png" ]; then
            cp "icon.png" "release/${PLUGIN_DIR}/icon.png"
          else
            echo "Warning: icon.png not found at repository root. Packaging without icon."
          fi

          cd "release"
          zip -r "../${ARCHIVE_NAME}" "${PLUGIN_DIR}"

      - name: Create or update GitHub release
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN || github.token }}
          ARCHIVE_NAME: orca-task-planner-${{ env.RELEASE_TAG }}.zip
        run: |
          if gh release view "${RELEASE_TAG}" >/dev/null 2>&1; then
            gh release upload "${RELEASE_TAG}" "${ARCHIVE_NAME}" --clobber
            gh release edit "${RELEASE_TAG}" --latest
          else
            gh release create "${RELEASE_TAG}" "${ARCHIVE_NAME}" --generate-notes --latest
          fi
