# orca-task-planner

[![English](https://img.shields.io/badge/README-English-1f6feb)](README.md)
[![简体中文](https://img.shields.io/badge/README-%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87-2ea44f)](README_zh.md)

`orca-task-planner` 是 Orca Note 的一体化任务规划与执行插件。

## 插件简介

面向 Orca Note 的任务中枢。它可以帮助你：

- 把“想到的事”在几秒内收集成任务
- 从清单、日程、回顾到复盘形成完整闭环
- 在 **激活任务** 中只看当前可推进事项
- 用 **我的一天** 快速安排今天的执行节奏
- 用内置计时器沉淀真实投入时长
- 用评分与视图减少优先级决策成本

## 主要功能

### 0）任务快速收集（快速新增任务块）

任务管理的第一步不是“计划得多好”，而是“先不丢”。  
插件支持在笔记中即时收集任务，尽量降低记录阻力：

- 在编辑区可直接把当前块快速转为任务（`Alt+Enter`）；
- 在任务管理面板可通过“添加任务”快速新增任务块；
- 新增后可继续在属性面板补充时间、依赖、优先级等信息。

你可以先把任务记下来，随后再批量补齐计划信息，不打断当前思路。

### 1）任务状态快速切换

插件把状态切换做成“零跳转、低心智负担”的编辑动作：

- 在任意块按 `Alt+Enter` 可直接创建任务，并循环切换状态；
- 中文状态顺序为：`待开始 -> 进行中 -> 已完成 -> 待开始`；
- 点击任务左侧状态图标也可执行同样切换；
- 切换为“进行中”时，会自动记录开始时间，便于后续跟踪；
- 若开启计时自动启动，切换到“进行中”时会自动开始计时。

状态推进和执行记录都发生在编辑器里，连续工作流更顺。

### 2）任务属性面板：快速编辑任务属性

点击任务标签即可打开属性面板，在一个入口完成“补全信息 -> 保存 -> 继续执行”：

- 基础字段：状态、开始时间、到期时间、标签、备注、收藏；
- 计划字段：重要性、紧急度、工作量；
- 依赖字段：依赖任务、依赖模式（`ALL` / `ANY`）、依赖延迟；
- 周期字段：回顾规则、重复规则。

面板支持数值校验与快速保存；依赖任务可通过块引用选择。相比分散编辑，这种集中式方式更适合频繁调整的真实项目任务。

### 3）任务管理面板：统一查看与管理所有任务

任务管理面板是插件的“操作中枢”，把查看、筛选、执行和维护放在一起。  
主要视图包括：

- **仪表盘**：全局概览（完成率、到期压力、阻塞项、优先任务）；
- **我的一天**：当日聚焦任务清单与日程排期（列表/日程双模式）；
- **激活任务**：当前可执行任务清单（主执行入口）；
- **全部任务**：完整任务树（支持层级整理与拖拽）；
- **收藏任务**：人工标记的重点任务；
- **即将到期**：时间窗口内到期任务；
- **回顾**：待回顾任务与批量回顾操作；
- **自定义视图**：按规则保存的场景化视图。

在同一处即可完成“发现问题 -> 调整计划 -> 执行落地 -> 周期复盘”。

### 4）激活任务：基于 GTD 思路的执行清单

`激活任务` 的目标是：每次打开面板，都直接看到“现在就能做、且最该先做”的任务。

#### 判定规则

任务进入 `激活任务` 需要同时满足：

1. 任务未完成且未取消；
2. 已到开始时间（或未设置开始时间）；
3. 不存在未完成子任务；
4. 祖先依赖链不阻塞；
5. 本任务依赖条件满足（`ALL` / `ANY` + 延迟）。

#### 优先级评分公式

激活任务按以下公式评分并排序：

```text
base = 0.40*I + 0.22*U + 0.20*D + 0.10*S + 0.08*C
score = base * criticalBoost * deadlineBoost * startByBoost * agingBoost / timePenalty
```

- `timePenalty = 1 + 0.9*EffN`
- `criticalBoost = 1 + 0.3*Criticality`
- `deadlineBoost = 1 + 0.25*OverdueN`
- `startByBoost = 1 + 0.22*StartBy`
- `agingBoost = 1 + 0.12*AgingN`

- `I/U`：Importance / Urgency 的非线性映射（`50` 为中性点）
- `D`：到期因子（无截止日为 `45`，逾期为 `100`，其余按指数衰减）
- `S`：开始时间因子（到达开始时间为 `100`，未来任务按二次曲线衰减，最低 `10`）
- `C`：上下文因子（收藏任务 `80`，否则 `50`）
- `EffN`：工作量归一化（`effort/100`）
- `Criticality`：依赖关键性（`0.6*descendants + 0.4*dependencyDemand`）
- `OverdueN`：逾期天数归一化（`daysOverdue/7`）
- `StartBy`：最晚开工压力（由工作量与剩余天数共同决定）
- `AgingN`：等待时长因子（`waitingDays/14`）
- `dependencyDemand`：下游任务需求强度（下游任务越重要/紧急，值越高）

排序规则：

1. 已逾期任务优先；
2. 分数降序；
3. 到期时间升序；
4. 内部稳定 ID 顺序。

你不需要手动反复比较任务，列表会自动把注意力拉到当前最值得推进的事项。

#### 建议使用方式

- 每日开始工作时，先查看 `激活任务`；
- 优先处理列表前部任务，减少切换成本；
- 配合 `即将到期` 视图做短期排程，配合 `仪表盘` 做全局校准。

### 5）重复任务功能

把例行工作从“反复新建任务”升级为“规则自动推进”：

- 支持按天/周/月重复；
- 支持间隔、指定周几（按周）、最大次数、结束日期；
- 任务完成后，系统会自动推进到下一周期；
- 对有层级的任务，可同步推进相关子任务状态与时间节奏。

适合晨间例会、周报、巡检、复盘等固定节奏工作。

### 6）任务回顾功能

回顾功能让长期任务持续被看见，不再“开了头就沉底”：

- 支持单次回顾和周期回顾；
- 可配置回顾频率（如每 N 天/周/月）；
- 在 `回顾` 视图中集中处理待回顾任务；
- 支持批量“标记已回顾”，自动推进下一次回顾时间。

### 7）自定义视图功能

自定义视图把高频筛选场景固化成按钮，一键回到你的工作上下文：

- 支持创建、编辑、删除视图；
- 支持 AND/OR 组合条件；
- 可按状态、时间、依赖、标签等字段组合筛选；
- 视图会持久保存，重启后仍可直接使用。

适用于“工作/家庭/项目阶段/周计划”等长期场景分组。

### 8）任务仪表盘

`仪表盘` 提供任务系统的“经营视角”：

- 关键指标：任务总量、激活任务、回顾任务、超期任务；
- 结构指标：状态分布、到期压力；
- 风险指标：主要阻塞原因；
- 执行指标：高优先激活任务列表。

适合每天开工前 1 分钟做节奏校准。

### 9）我的一天（My Day）视图

`我的一天` 聚焦“今天要完成什么”，把日计划做成可执行界面：

- 支持把任务加入“我的一天”清单；
- 支持列表模式与日程模式切换；
- 日程模式支持时间轴拖拽排期与拖动时长；
- 任务卡片支持右键菜单操作；
- 支持自动同步到今日日志分区；
- 当今日日志已存在该任务时，不会重复插入镜像块。

你可以从“任务列表”直接进入“时间安排”，把计划变成具体时间块。

### 10）任务计时功能

任务计时器帮助你把“做了很久”变成可量化的投入数据：

- 支持 `直接计时` 与 `番茄钟计时` 两种展示模式；
- 支持在任务行与行内控件中开始/停止计时；
- 全局仅允许一个任务处于计时中（启动新的会停止旧的）；
- 可配置切换到“进行中”自动开始计时；
- 切换到“已完成”自动停止计时；
- 计时数据会持久化保存。

适合复盘估时偏差、沉淀个人节奏。

### 11）启动任务汇总通知

每次启动插件时，可先看到“今天工作盘面”的快照，包含：

- 激活任务数；
- 超期任务数；
- 临期任务数（按即将到期窗口计算）。

通知开关可控，不需要时可以关闭。

## 安装方式

### 从源码安装

1. 将项目放到 Orca 插件目录，例如：  
   `C:\Users\<你的用户名>\Documents\orca\plugins\orca-task-planner`
2. 构建：

```bash
npm install
npm run build
```

3. 启动/重启 Orca Note。
4. 在插件设置中启用 `orca-task-planner`。

构建产物：`dist/index.js`。

## 快速上手

1. 打开命令面板，执行 `Open task management panel`（进入统一工作台）。
2. 创建任务：
   - 把光标放到任意块
   - 按 `Alt+Enter`
   - 状态循环：`待开始 -> 进行中 -> 已完成 -> 待开始`
3. 打开任务属性：
   - 点击任务标签，或
   - 执行 `Open task property popup`
4. 配置核心字段：
   - 开始时间 / 到期时间
   - 依赖模式（`ALL` 或 `ANY`）
   - 依赖延迟（如需要）
   - 重要性 / 紧急度 / 工作量
5. 切到 **激活任务**，按列表顺序执行。
6. 在 `全部任务` 管理层级与拖拽结构。
7. 使用 `我的一天` 做当日聚焦和时间排程。
8. 在 `回顾` 做周期回顾并批量标记。
9. 在 `即将到期` 和 `仪表盘` 做周期计划与总览。

## 命令与快捷键

- `Alt+Enter`：创建任务 / 循环切换任务状态
- `Open task management panel`：打开任务管理面板
- `Open task property popup`：打开任务属性面板

## 数据与持久化

- 面向用户的任务字段存储在任务标签属性中
- 扩展规划字段存储在块属性 `_mlo_task_meta`
- 任务计时数据存储在块属性 `_mlo_task_timer`
- 自定义视图和“我的一天”状态存储在插件本地数据中
- 默认本地持久化，不依赖外部服务

## 常见问题

### 为什么任务没出现在激活任务？

最常见原因：

- 开始时间还没到
- 依赖任务未完成
- 依赖延迟尚未结束
- 祖先依赖仍阻塞
- 仍有未完成子任务
- 任务已完成/已取消

### 为什么激活任务排序会变化？

当任务字段或依赖状态变化时（如到期时间、紧急度、依赖完成状态），评分会自动更新，排序会随之变化。

### 依赖模式 `ALL` 和 `ANY` 如何选择？

- `ALL`：所有前置都完成后才能开始
- `ANY`：任一前置完成即可开始

### 可以修改任务标签名称吗？

可以，在插件设置里修改 **任务标签名称**。

### 如何调整“即将到期”范围？

在插件设置中调整：

- **即将到期天数**
- **即将到期包含超期任务**

### 如何设置任务面板首次打开的默认视图？

在插件设置中调整：

- **任务面板默认视图**（用于首次打开任务面板时展示的视图）

### 可以隐藏顶部任务面板图标吗？

可以，在插件设置中调整：

- **显示任务面板图标**（默认勾选）

### 如何启用“我的一天”视图？

在插件设置中开启 **Enable My Day**，然后在任务面板切换到 `My Day` 视图。

### “我的一天”跨天边界怎么计算？

通过 **My Day start hour** 设置（0-23），系统按该本地小时切分“新的一天”。

### 任务计时与状态切换有什么联动？

如果开启 **Auto start timer when status becomes Doing**，切换到“进行中”会自动开始计时；切换到“已完成”会自动停止计时。

### 为什么开始一个任务计时后，另一个任务计时会停止？

插件采用“全局单任务计时”策略，避免多任务同时计时导致时长统计失真。

### 可以关闭启动任务汇总通知吗？

可以，在插件设置中关闭 **Notify task summary on startup**。

## 开发

```bash
npm install
npm run dev
npm run build
```
